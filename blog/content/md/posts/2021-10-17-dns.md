{:title "A short overview of DNS"
 :layout :post
 :tags []}

I've recently changed DNS provider for this blog, and that forced me to look
into how DNS works a bit closer. I did manage a DNS server for a couple years
circa 2006, but I have to say I'd forgotten most of it. In case I forget it
again, I'm recording my notes here.

## DNS zone

A DNS "zone" is a set of records. There are various types of records; in
general, a record is essentially a line of text of the form:

```
domain ttl class type data
```

The class is usually IN (standing for "internet"). There are many types; some
common ones are `A`, `MX`, `NS`, and `TXT`. There is only one record of a given
type for a given domain. `A` records indicate the IP address of the server
corresponding to the listed domain; `MX` records indicate the address (usually
as a domain name) of the mail server to send emails @ that domain to; `NS`
records indicate the name servers for the listed domain; and `TXT` records are
free-form text. The TTL (time to live) is a number of seconds during which the
entry can be cached.

The DNS zone for a given domain can include entries for subdomains, which is
why the domain is part of the record. For example, these two records are part
of the one zone for `cuddly-octo-palm-tree.com`:

```
cuddly-octo-palm-tree.com.        30    IN    A    52.204.159.248
www.cuddly-octo-palm-tree.com.    30    IN    A    52.204.159.248
```

## Caching server

A DNS "name server" is a system that serves DNS records, i.e. an IP address
that responds to DNS queries. Queries come in the form of domain + type, i.e.
"please give me the `A` record for `example.com`". If the server has that in
its own cache, it checks when it got it and whether that's more seconds ago
than the TTL. If it is not, it means the entry is still valid, so it serves it.

If the server does not have a fresh-enough response, it needs to fetch it.
There may be multiple levels of caching here; many DNS servers have another DNS
server configured as a fallback. But, ultimately, we'll reach a point where we
need to query the authority on that domain. This is where the hierarchical
nature of DNS comes in.

## Authoritative server

DNS segments read from right to left: `images.example.com` is a subdomain of
`example.com` which is a subdomain of `com`. If *sub*domains are thought of as
being *under* their domain, it makes sense that the last segment is called a
*top-level* domain. There is a finite, well-known list of top-level domains
(TLDs), administered (the list) by ICANN. DNS servers cannot rely on the DNS system to
know the IP addresses of the authoritative servers for TLDs, so for the rest of
this piece we'll assume their IP addresses are just known, somehow.

Imagine you are a DNS server trying to resolve the IP address (i.e. the `A`
record) for `images.example.com`. First, you'd query the authoritative server
for `com` (which we assume you know how to map to an IP address) for the `NS`
record for `example.com`. If that comes back empty, you know the `example.com`
name is not registered and you can stop there. If it does come back with an
answer, it will contain a list of domain names for further queries on
`example.com`. You'll need to resolve _those_ names to IP addresses to be able
to query them. We'll skip the recursion and assume that part works out.

Now that you have an IP address you can query for `example.com` records, you
can ask it for the `A` record of `images.example.com`. If that returns you an
IP address, you're all set. If not, you need to ask for an `NS` record for
`images.example.com`. If there isn't one, you're done: there is no IP address
for `images.example.com`. If there is one, then we're not quite done yet.

The last step is to ask for the `A` record for `images.example.com` to the DNS
server that serves the `images.example.com` zone. If it has one, we're done; if
it doesn't have one, we're also done: there is no further subdomain to query.

In practice, there is one extra record to check for at each level: IP addresses
can also be associated to domain names through the `CNAME` record, so checking
only for `A` records is not enough. A `CNAME` record can be thought of as a
redirection: the data part of the record is going to be a domain name, and the
meaning is that the domain (first field of the record) should resolve to the
same IP address as the data (last field of the record).

It is bad form for the data field of a `CNAME` entry to point to a domain name
that itself ultimately results in a `CNAME` record; good DNS practice would
limit the number of such redirections to a single one.

Finally, note that at each "level" of domain you have to figure out whether the
current zone includes records for the subdomain you're interested in directly,
or if it delegates to another zone for that. I do not know whether the DNS
protocol specifies in which order you should check for things; in the above, my
imaginary server checks for the `A` record of `images.example.com` in the
`example.com` zone _before_ asking for the `NS` record of the
`images.example.com` zone. But asking for `NS` records first might work better
overall, as those might be more stable and thus have longer TTLs on average,
affording better caching. For example, if right after resolving the `A` record
for `images.example.com` you need the `TXT` record for it, if you'd cached the
`NS` record you can jump directly to the right zone.

I do not know if there is anything that prevents the `example.com` zone from
having _both_ an `A` and a `NS` record for `images.example.com`, nor what
happens if the `A` record for `images.example.com` in the `example.com` zone is
different from the `A` record for `images.example.com` in the
`images.example.com` zone. For me, I'll just not do that.

## Registrars

TLDs are often owned by entities with no desire to interact directly with DNS
users, or to host a DNS server for their TLD. I imagine the details may vary
from TLD to TLD, but, in general, people who want to register a domain name
(registrants) under a TLD need to go through a _registrar_ that has an existing
relationship with the corresponding TLD owner.

Registrars make sure the very first step in DNS resolution works. The details
are not super important here, but the registrar can be thought of as managing
the DNS zone of the TLD, with the special case that that zone only contains
`NS` entries.

That is, of course, not _all_ a registrar does: the bulk of their work is to
keep track of who owns each domain name, following the rules of ICANN as well
as the additional constraints imposed by the TLD (e.g. the `eu` TLD mandates
that domain holders be EU residents).

Registering a domain name is generally not very useful unless you also have a
server hosting your zone. Most "DNS providers" will serve both roles and do the
"tell your registrar about your zone" step for you, but it is definitely
possible for the registrar and the DNS name server host to be separate
entities. In that case, the registrant needs to tell the registrar the names of
the DNS servers that host the zone, essentially replicating the `NS` record for
the domain.

## `hosts` file

End-user devices are generally configured to look for DNS entries in two steps.
First, there is a `hosts` file somewhere (`/etc/hosts` on Unix systems,
`C:\Windows\System32\drivers\etc\hosts` on Windows) that takes absolute
priority. This is a simple text file where each line is an entry with two
space-separated fields, where the first field is an IP address and the second
field is a domain name. Any request for a domain name present in the `hosts`
file will resolve to the IP address on the same line.

This may or may not be how "end-of-caching-chain" DNS servers resolve TLDs.

If an address is not in the `hosts` file (which should be the vast majority of
them), then the device will send a DNS query to its configured DNS server(s).
For most consumer devices those are set automatically to their ISP's DNS
servers through the DHCP protocol, but that can be overridden. In either case,
the DNS servers are designated by their IP address, as specifying a name for
them would be a bit recursive. In a bad way.

The `hosts` file is very useful for temporary testing, but in general it
shouldn't be relied upon too much as it gives you a different view of the
internet from everyone else's.

## `curl` DNS override

I recently discovered that the `curl` command has a CLI flag that lets you
override DNS resolution. This is a great alternative to a temporary change to
the `hosts` file as it does not require root access and there is no risk to
forget to set things back.

The flag is `--connect-to domain:port:IP:port`, and it will resolve `domain` to
`IP` (and map `port` to `port`, though I generally set those to the same value,
as you might have guessed) without going through any DNS resolution.

## Conclusion

That's it: my working knowledge of how DNS works. It's a bit fuzzy in some
places, most notably TLD handling, but it's been good enough to let me "make
things work" so far.

If any of the above is blatantly wrong, please let me know.
